<!doctype html>
<html>
<head>
<title>PopRelayServer Test</title>
<link rel="stylesheet" type="text/css" href="http://panopo.ly/panopoly.css">
<style type=text/css>

body
{
	background-color:	#fff;
	color:			#000;
	font-family:		"futura-pt",sans-serif;
	margin:			auto 10% auto 10%;
}

h1
{
	font-size:			30pt;
	letter-spacing:		-2px;
	font-weight:		600;
	font-family:		"futura";
	margin:				none;
}

a
{
	color:			#c30;
	font-size:		18pt;
	font-style:		normal;
	font-weight:		700;
	letter-spacing:		4px;
}

.Center
{
	margin:		auto;
	display:	block;
	text-align:	center;
}

#LastTextMessage
{
	text-align:	left;
}

Input
{
	margin:		10px;
}

/* off at start */
#ControlBox
{
	display:	none;
}

#RegisterButton
{
}


#ClientListBox
{
	margin:		10px;
	padding:	10px;
	border:		1px #ccc solid;
	background-color:	#ffb;
}

.ClientBox
{
	width:		25%;
	float:		left;
	margin:		10px;
	padding:	10px;
	border:		none;
	background-color:	#bfb;
}

.MessageBox, #LastTextMessage, #LastErrorMessage, #TextFrameRate, #LastImageBox, #MicRecorder
{
	margin:		10px;
	padding:	10px;
	border:		1px #ccc solid;
	background-color:	#fbb;
}

header div, header h1
{
	margin: 0pt;
	float:	left;
}

header:after, #MicRecorder:after
{
	clear:		both;
	content:	"";
	display:	block;
}

#MicRecorder canvas, #MicRecorder h2, #MicRecorder div
{
	float:			left;
}

#MicRecorder canvas
{
	display:	none;
	height:		10em;
	width:		50%;
	background:	green;
}

</style>
<script src="SoyWebsocket-1.0.js"></script>
</head>
<body>
	<header>		
		<div class="Center">
		<h1 id="Panopoly">PopRelay</h1>

		<div id=ServerConnectionBox>
		</div>
		<div id=ClientConnectionBox>
		</div>

		<div id=ControlBox>
			<div id=RegisterButton>
			<input type=button value="Register Server" onclick=RegisterServer() />
			<input type=button value="Register Client" onclick=RegisterClient() />
			</div>
		</div>
		
	</header>
	
	
		<div id=MicRecorder>
			<h2>Mic Recorder</h2>
			<div>
			<input type=button value="Record Mic" onclick=StartMicRecording('Microphone','MicrophoneCanvas') />
			<input type=button value="Stop Mic" onclick=StopMicRecording('Microphone') />
			</div>
			<canvas id=MicrophoneCanvas />
			</div>
		</div>

		<div id=LastTextMessage></div>
		<div id=TextFrameRate>X fps</div>
		<div id=LastErrorMessage></div>
		<div id=LastImageBox><img id=lastImage /><div id=ImageFrameRate>X fps</div></div>
		<div>
			<input id=ClearLogMessagesButton type=button value="Clear" onclick=ClearLogMessages() />
			<div id=LogMessages></div>
		</div>

		<script>
			var ShowControls = function()
			{
				var $div = document.getElementById('ControlBox');
				$div.style.display = 'block';
				ClearMessages();		
				//RegisterServer();
				ClearClientBoxes();
				LoopUpdateAllClientTextBoxes();
			}

			function LoopUpdateAllClientTextBoxes()
			{
				setTimeout( LoopUpdateAllClientTextBoxes, 100 );
				UpdateAllClientTextBoxes();
			}
			
			function ClearLogMessages()
			{
				var $div = document.getElementById('LogMessages');
				while ($div.firstChild) {
					$div.removeChild($div.firstChild);
				}
				
				var $button = document.getElementById('ClearLogMessagesButton');
				$button.style.visibility = 'hidden';
			}
		
			function LogMessage($MessageString)
			{
				//	log unhandled messages
				var $div = document.getElementById('LogMessages');
				
				var MessageDiv = document.createElement('span');
				MessageDiv.innerText = $MessageString;
				MessageDiv.className = 'MessageBox';
				console.log(MessageDiv);
				$div.appendChild( MessageDiv );
				
				
				var $button = document.getElementById('ClearLogMessagesButton');
				$button.style.visibility = 'inherit';
			}

			function IsString(value)
			{
				return typeof value === 'string';
			}

			function GetTimeMs()
			{
				var d = new Date();
				var n = d.getTime();
				return n;
			}

			var $FpsMeta = {'LapTime':GetTimeMs(),'ImageFrameCount':0,'ImageKbCount':0,'TextFrameCount':0,'TextKbCount':0};

			function UpdateFps()
			{
				//	time since last lap in secs
				var NowMs = GetTimeMs();
				var LapDurationMs = NowMs - $FpsMeta.LapTime;
				var LapDurationSecs = LapDurationMs / 1000;

				var ImageFrameRate = $FpsMeta.ImageFrameCount * LapDurationSecs;
				var ImageKbRate = $FpsMeta.ImageKbCount * LapDurationSecs;
				var TextFrameRate = $FpsMeta.TextFrameCount * LapDurationSecs;
				var TextKbRate = $FpsMeta.TextKbCount * LapDurationSecs;
				
				UpdateImageFpsMessage( "" + ImageFrameRate.toFixed(2) + " fps, " + ImageKbRate.toFixed(2) + " kb/sec" );
				UpdateTextFpsMessage( "" + TextFrameRate.toFixed(2) + " fps, " + TextKbRate.toFixed(2) + " kb/sec" );

				$FpsMeta.ImageFrameCount = 0;
				$FpsMeta.ImageKbCount = 0;
				$FpsMeta.TextFrameCount = 0;
				$FpsMeta.TextKbCount = 0;
				$FpsMeta.LapTime = NowMs;
			}

			function UpdateMessage($MessageString)
			{
				var Box = document.getElementById('LastTextMessage');
				Box.innerText = $MessageString;
			}

			function UpdateErrorMessage($MessageString)
			{
				var Box = document.getElementById('LastErrorMessage');
				Box.innerText = $MessageString;
			}

			function UpdateImageFpsMessage($MessageString)
			{
				var Box = document.getElementById('ImageFrameRate');
				Box.innerText = $MessageString;
			}

			function UpdateTextFpsMessage($MessageString)
			{
				var Box = document.getElementById('TextFrameRate');
				Box.innerText = $MessageString;
			}

			function UpdateImage($SourceUrl,$SourceKb)
			{
				var Img = document.getElementById('lastImage');
				Img.src = $SourceUrl;
				$FpsMeta.ImageFrameCount++;
				$FpsMeta.ImageKbCount += $SourceKb;
			}



			function TStream(Name)
			{
				this.Name = Name;
				this.OnNewData = function(Blob)
				{
					
				};
				this.OnStarted = function()
				{
					LogMessage("Stream " + this.Name + " started");
				};
			}



			function StartMicRecording(StreamName,CanvasId)
			{
				var Canvas = document.getElementById(CanvasId);
				var Constraints = {
					audio: true
				};
				
				
				var DrawData = function(Data)
				{
					//	show
					Canvas.style.display = 'block';
					var Context = Canvas.getContext("2d");
					var Width = Canvas.width;
					var Height = Canvas.height;
					var HalfHeight = Height / 2;
					var HalfWidth = Width / 2;
					
					//	clear
					Context.fillStyle = "#000000";
					Context.fillRect(0,0,Width,Height);
					
					//	draw lines
					Context.beginPath();
					var Gradient = Context.createLinearGradient( HalfWidth,0,HalfWidth,Height);
					Gradient.addColorStop(0/5, '#FF0000');
					Gradient.addColorStop(1/5, '#FFff00');
					Gradient.addColorStop(2/5, '#00ff00');
					Gradient.addColorStop(3/5, '#ffff00');
					Gradient.addColorStop(4/5, '#ff0000');
					Context.lineWidth = 1;
					Context.strokeStyle = Gradient;
					for ( var x=0;	x<Data.length;	x++ )
					{
						var Sample = Data[x];
						var SampleMax = 1.0;
						Sample = Math.min( SampleMax, Math.max( -SampleMax, Sample ) );
						var LineThickness = 5;
						var y = HalfHeight + ( Sample * HalfHeight );
					
						Context.moveTo( x, y-LineThickness );
						Context.lineTo( x, y+LineThickness );
					}
					Context.stroke()
				};
				
				var OnData = function(Stream,Timecode,Data)
				{
					DrawData(Data);
					
					if ( Stream.FirstTimecode == null )
						Stream.FirstTimecode = Timecode;
					
					var Timecode = Timecode - Stream.FirstTimecode;
					
					//console.log("Stream " + Stream.Name + " data...");
					//console.log(Data);
				};
				
				
				var OnError = function(Error)
				{
					LogMessage("Error capturing user media: " + Error.name + " (" + Error.message + ")" );
					console.log(Error);
				};
				
				var CreateAudioSink = function(MediaStream)
				{
					var Stream = new TStream(StreamName);
					
					var Channels = 2;
					var SampleRate = 44100;
					var BufferSecs = 3;
					var Size = SampleRate * BufferSecs;
					
					
					//	gr: analyser doesn't run with offline context
					//var Context = new OfflineAudioContext( Channels, Size, SampleRate );
					var Context = new AudioContext();
					var AudioSource = Context.createMediaStreamSource(MediaStream);
					
					var DataAsFloat = false;
					var UseAnalyser = false;
					
					
					if ( UseAnalyser )
					{
						var AnalyserNode = Context.createAnalyser();
						AnalyserNode.fftSize = 2048;
						
						if ( DataAsFloat )
							var DataBuffer = new Float32Array(AnalyserNode.frequencyBinCount);
						else
							var DataBuffer = new Uint8Array(AnalyserNode.frequencyBinCount);
						
						
						AudioSource.connect( AnalyserNode );
					}
					else
					{
						var ChannelsIn = 2;
						var ChannelsOut = 1;
						var BufferSize = 512;
						var Processor = Context.createScriptProcessor( BufferSize, ChannelsIn, ChannelsOut );
						var HandleData = function(AudioDataEvent)
						{
							var Channels = AudioDataEvent.inputBuffer.numberOfChannel;
							var Channel = 0;
							var InputData = AudioDataEvent.inputBuffer.getChannelData( Channel );
							//var Timecode = AudioDataEvent.timeStamp;
							var Timecode = AudioDataEvent.playbackTime;
							
							OnData( Stream, Timecode, InputData );
							//console.log(AudioDataEvent);
						};
						Processor.onaudioprocess = HandleData;
						
						AudioSource.connect( Processor );
						Processor.connect( Context.destination );
					}
					

					var UpdateLoop = function()
					{
						if ( UseAnalyser )
						{
							console.log("Update loop");
							
							if ( DataAsFloat )
								AnalyserNode.getFloatFrequencyData(DataBuffer);
							else
								AnalyserNode.getByteFrequencyData(DataBuffer);
							console.log(DataBuffer);
						}
						
						Stream.Timer = setTimeout( UpdateLoop, 2000 );
					}
					UpdateLoop();
					
				}
				
				var CreateRecorder = function(MediaStream)
				{
					var TimesliceInterval = 5000;
					var Stream = new TStream(StreamName);
					Stream.MediaStream = MediaStream;
					Stream.Recorder = new MediaRecorder(MediaStream);
					Stream.Recorder.ondataavailable = function(DataEvent)	{	OnData( Stream, DataEvent );	};
					Stream.FirstTimecode = null;
					Stream.Recorder.start(TimesliceInterval);
					Stream.OnStarted();
					
					//	grab data regularly
					var UpdateLoop = function()
					{
						console.log("Update loop");
						Stream.Recorder.requestData();
						Stream.Recorder.Timer = setTimeout( UpdateLoop, TimesliceInterval );
					}
					UpdateLoop();
				}
				
				var OnSuccess = function(MediaStream)
				{
					console.log("Got user medias");
					console.log(MediaStream);
					CreateAudioSink( MediaStream );
					//CreateRecorder( MediaStream );
				};
				
				navigator.mediaDevices.getUserMedia(Constraints).then(OnSuccess).catch(OnError);
			}
						

			function OnTextMessage($Socket,$MessageString)
			{
				UpdateMessage( $MessageString );
				$FpsMeta.TextFrameCount++;
				$FpsMeta.TextKbCount += $MessageString.length / 1024;
			}

			function OnBinaryMessage($Socket,$MessageBlob)
			{
				try
				{
					var ImageUrl = URL.createObjectURL($MessageBlob);
					UpdateImage( ImageUrl, $MessageBlob.size/1024  );
				}
				catch(Exception)
				{
					UpdateErrorMessage("Error creating image:" + Exception );
				}

			}


			function RegisterServer(Socket)
			{
				LogMessage("Registering as server");
				Socket.SendMessage('iamserver');
			}
		
			function RegisterClient(Socket)
			{
				LogMessage("Registering as client");
				Socket.SendMessage('iamclient');
			}



			//	bootup

			ClearLogMessages();
			
			var DefaultClientHostname = window.location.hostname + ":8080";
			var ClientSocket = new SoyWebSocket(null, DefaultClientHostname, document.getElementById('ClientConnectionBox'), RegisterClient, function(){} );
			ClientSocket.mOnTextMessage = OnTextMessage;
			ClientSocket.mOnBinaryMessage = OnBinaryMessage;
			
			var DefaultServerHostname = window.location.hostname + ":8081";
			var ServerSocket = new SoyWebSocket(null, DefaultServerHostname, document.getElementById('ServerConnectionBox'), RegisterServer, function(){} );
			ServerSocket.mOnTextMessage = OnTextMessage;
			ServerSocket.mOnBinaryMessage = OnBinaryMessage;

			setInterval( UpdateFps, 1000 );

		</script>

		</div>

</body>
</html>
